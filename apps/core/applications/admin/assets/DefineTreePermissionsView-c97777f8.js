import{cQ as e,bs as t,bt as i,n as r,h as s,s as n,Q as l,bB as a,j as o,o as d,M as c,w as u,bv as p,F as m,cR as b,I as h,L as g,E as f,cB as v,R as y,B as _,bC as C}from"./index-da778430.js";import{g as A}from"./getLibrariesQuery-8f805ce0.js";import{F as S,t as k,v as T,w,C as x}from"./DefinePermByUserGroupView-a11a63fc.js";import{T as j}from"./Header-90427ac0.js";import{P as I}from"./Popup-65e7a174.js";import{g as P}from"./getAttributesQuery-614214c0.js";function O(t,i){return e(t,i,!0)}const B=({loading:e,libraries:s,...n})=>{const l=t().lang,a=s?s.map((e=>({key:e.id,value:e.id,text:i(e.label,l)}))):[];return delete n.t,delete n.tReady,delete n.defaultNS,delete n.i18nOptions,delete n.reportNS,r(S.Dropdown,{...n,search:!0,options:a})};function N(e){const{loading:t,data:i}=s(A);return r(B,{...e,loading:t,libraries:i&&i.libraries?i.libraries.list:null})}B.defaultProps={loading:!1,libraries:[]};var R=function(e,t,i){for(var r=-1,s=null==e?0:e.length;++r<s;)if(i(t,e[r]))return!0;return!1};const $=n(l.Item)`
    &&&& {
        cursor: pointer;
        padding: 0.5rem;
    }
    &:hover {
        background-color: ${a};
    }
`;function z({attributes:e,onSelect:s}){const{lang:n}=t(),{t:a}=o(),u=e=>()=>{s(e)};return d(l,{divided:!0,"aria-label":"attribute-selector-list",children:[!e.length&&r(c,{info:!0,size:"tiny",children:a("permissions_settings.no_attributes_to_add")}),e.map((e=>d($,{onClick:u(e),children:[r(l.Header,{children:i(e.label,n)}),r(l.Description,{children:e.id})]},e.id)))]})}function D({library:e,selectedAttributes:t,onSelectAttribute:i}){var s;const{t:n}=o(),[l,a]=u.useState(!1),[c,{loading:v,error:y,data:_,called:C}]=O(P,{variables:{libraries:e?[e.id]:null,type:[p.tree]}});u.useEffect((()=>{l&&!C&&c()}),[l,C]);const A=((null==(s=null==_?void 0:_.attributes)?void 0:s.list)??[]).filter((e=>!t.includes(e.id)));return d(m,{children:[d(b,{basic:!0,compact:!0,onClick:()=>{a(!0)},children:[r(h,{name:"plus"}),n("permissions_settings.add_permissions_attribute")]}),v&&r(g,{size:"small"}),y&&r(f,{message:y.message,size:"small"}),l&&C&&!v&&!y&&r(z,{attributes:A,onSelect:e=>{i(e.id),a(!1)}})]})}const Q=n.div`
    display: flex;
    gap: 1rem;
    flex-direction: column;
    min-width: 225px;
    max-width: 90vw;
    font-size: 1rem;
`,E=n.div`
    cursor: pointer;
`,F=n(j.Cell)`
    &&& {
        ${e=>!e.$hasAttributes&&"border-top: none;"}
    }
`,G=v.and;function L({permissionsSettings:e,onChangeSettings:s,library:n,readonly:l,...a}){const{t:c}=o(),{lang:u}=t(),[m,g]=y.useState((null==e?void 0:e.relation)??v.and),f=(null==e?void 0:e.permissionTreeAttributes)??[],C=d(E,{...a,children:[r(h,{name:"cog"}),c("permissions_settings.title")]}),A=Object.values(v),S=t=>()=>{g(t),s({permissionTreeAttributes:e.permissionTreeAttributes.map((e=>e.id)),relation:t})};return p.tree,n&&n.id,r(I,{trigger:C,on:"click",closeOnEscape:!0,position:"bottom left",style:{maxWidth:"none"},children:d(Q,{children:[d("div",{children:[r("h5",{children:c("permissions_settings.permissions_attributes")}),d(j,{compact:!0,children:[r(j.Body,{children:f.map((t=>{return d(j.Row,{children:[r(j.Cell,{children:i(t.label,u)}),r(j.Cell,{width:3,children:!l&&r(b,{"aria-label":"remove",icon:"trash alternate outline",onClick:(n=t.id,()=>{s({permissionTreeAttributes:f.map((e=>e.id)).filter((e=>e!==n)),relation:(null==e?void 0:e.relation)??G})})})})]},t.id);var n}))}),!l&&r(j.Footer,{children:r(j.Row,{children:r(F,{colSpan:2,$hasAttributes:!!f.length,children:r(D,{library:n,onSelectAttribute:t=>{const i={permissionTreeAttributes:[...f.map((e=>e.id)),t],relation:(null==e?void 0:e.relation)??G};s(i)},selectedAttributes:f.map((e=>e.id))})})})})]})]}),f.length>1&&d("div",{children:[r("h5",{children:c("permissions_settings.operator")}),r(_.Group,{basic:!0,children:A.map((e=>r(_,{disabled:l,compact:!0,onClick:S(e),active:m===e,children:c(`permissions_settings.operator_${e}`)},e)))})]})]})})}const H=({treeAttribute:e,permissionType:t,applyTo:i,readOnly:s})=>{const[n,l]=y.useState({node:{id:k},path:[],treeIndex:0}),[a,o]=y.useState({node:{id:k},path:[],treeIndex:0}),d=e=>o(C(e)!==C(a)?e:null);if(!e.linked_tree)return r("p",{children:"Cannot find tree"});const c=[r(T,{treeId:e.linked_tree.id,onClick:e=>l(C(e)!==C(n)?e:null),selectedNode:n},"perm_tree")];return n&&(c.push(r(T,{treeId:"users_groups",onClick:d,selectedNode:a})),a&&c.push(r(w,{permParams:{type:t,applyTo:i,usersGroup:a.node.id!==k?a.node.id:null,permissionTreeTarget:{tree:e.linked_tree.id,nodeId:n.node.id!==k?n.node.id:null}},readOnly:s}))),r(x,{columnsNumber:3,columnsContent:c})};H.defaultProps={readOnly:!1};export{H as D,N as L,L as P,R as _,O as u};
