import{r as e,u as t,j as l}from"./useTranslation-6a88ac92.js";import{b5 as i,ar as r,as as n,ao as a,b3 as o,ct as s,aY as d,aQ as c,aU as p,bl as u}from"./recordIdentityFragment-3ccdcea1.js";import{A as m,l as y}from"./utils-c614281c.js";import{s as b}from"./styled-components.browser.esm-2d72260f.js";import{j as h,bL as k,bM as x,bN as g,bO as j,P as v,U as f}from"./ImportReducerContext-19d27c8c.js";import"./index-8160faf7.js";const I={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M608 112c-167.9 0-304 136.1-304 304 0 70.3 23.9 135 63.9 186.5l-41.1 41.1-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-44.9 44.9-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-65.3 65.3a8.03 8.03 0 000 11.3l42.3 42.3c3.1 3.1 8.2 3.1 11.3 0l253.6-253.6A304.06 304.06 0 00608 720c167.9 0 304-136.1 304-304S775.9 112 608 112zm161.2 465.2C726.2 620.3 668.9 644 608 644c-60.9 0-118.2-23.7-161.2-66.8-43.1-43-66.8-100.3-66.8-161.2 0-60.9 23.7-118.2 66.8-161.2 43-43.1 100.3-66.8 161.2-66.8 60.9 0 118.2 23.7 161.2 66.8 43.1 43 66.8 100.3 66.8 161.2 0 60.9-23.7 118.2-66.8 161.2z"}}]},name:"key",theme:"outlined"};var L=function(t,l){return e.createElement(m,h({},t,{ref:l,icon:I}))};const _=e.forwardRef(L);const C={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M574 665.4a8.03 8.03 0 00-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8a8.03 8.03 0 00-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zm258.6-474c-84.6-84.6-221.5-84.6-306 0L410.3 307.6a8.03 8.03 0 000 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6a8.03 8.03 0 000 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1zM610.1 372.3a8.03 8.03 0 00-11.3 0L372.3 598.7a8.03 8.03 0 000 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z"}}]},name:"link",theme:"outlined"};var T=function(t,l){return e.createElement(m,h({},t,{ref:l,icon:C}))};const A=e.forwardRef(T),w=b.div`
    display: grid;
    grid-template-columns: 7rem 3rem;
    grid-column-gap: 0.5em;
    grid-row-gap: 1em;
`;function S({columnIndex:e,sheet:r,onChange:n}){const{t:a}=t(),o=r.type===k.LINK,s=o||r.mode!==x.insert,d=o;return s||d?l.jsxs(w,{$hasKeyTo:o,children:[s&&l.jsxs(l.Fragment,{children:[l.jsxs("label",{children:[a("import.import_key"),": "]}),l.jsx(i,{checked:r.keyColumnIndex===e,onChange:e=>{n("key",e)}})]}),d&&l.jsxs(l.Fragment,{children:[l.jsxs("label",{children:[a("import.link_key"),": "]}),l.jsx(i,{checked:r.keyToColumnIndex===e,onChange:e=>{n("keyTo",e)}})]})]}):null}const O=b(n)`
    font-weight: bold;
    margin: 0.5em 0;
    color: ${r.errorColor};
`;function E({sheet:e}){var i;const{state:r}=g(),{t:a}=t(),o=(null==(i=null==r?void 0:r.settingsError)?void 0:i[e.name])??[],s=[j.MAPPING,j.KEY,j.KEY_TO];return l.jsxs(n,{direction:"vertical",children:[a("import.mapping"),l.jsx(O,{direction:"vertical",size:"small",children:s.map((e=>o.includes(e)?a(`import.settings_errors.${e}`):null))})]})}const N=e=>e.type===v.simple_link||e.type===v.advanced_link||e.type===v.tree,z=b(n)`
    && .ant-form-item-label {
        padding: 0;
        font-weight: bold;
    }
`;function K({sheetIndex:e,libraries:i,onLibrarySelect:r,onImportTypeSelect:n,onImportModeSelect:d,onLinkAttributeSelect:c,onTreeLinkLibrarySelect:p}){var u,m,b,h;const{lang:j}=a(),{t:f}=t(),{state:I}=g(),L=I.sheets[e],_=L.type===k.IGNORE,C=L.type===k.LINK&&(null==(u=L.linkAttributeProps)?void 0:u.type)===v.tree?((null==(b=null==(m=L.linkAttributeProps)?void 0:m.linked_tree)?void 0:b.libraries)??[]).map((e=>({key:e.library.id,value:e.library.id,label:y(e.library.label,j)}))):null;return l.jsx(o,{layout:"vertical",children:l.jsxs(z,{direction:"horizontal",size:"middle",wrap:!0,children:[l.jsx(o.Item,{label:f("import.type"),required:!0,children:l.jsx(s,{style:{minWidth:200},defaultValue:L.type,placeholder:f("import.select_type"),onChange:t=>n(e,t),children:Object.values(k).map((e=>l.jsx(s.Option,{value:e,children:f(`import.types.${e}`)},e)))})}),!_&&l.jsxs(l.Fragment,{children:[l.jsx(o.Item,{label:f("import.mode"),required:!0,children:l.jsx(s,{style:{minWidth:240},defaultValue:L.mode,placeholder:f("import.select_mode"),onChange:t=>d(e,t),children:Object.values(x).map((e=>l.jsx(s.Option,{value:e,children:f(`import.modes.${e}`)},e)))})}),l.jsx(o.Item,{label:f("import.library"),required:!0,children:l.jsx(s,{style:{minWidth:200},defaultValue:L.library??I.defaultLibrary,placeholder:f("import.select_library"),onChange:t=>r(e,t),children:i.map((e=>l.jsx(s.Option,{value:e.id,children:y(e.label,j)||e.id},e.id)))})}),L.type===k.LINK&&L.library&&l.jsx(o.Item,{label:f("import.link_attribute"),required:!0,children:l.jsx(s,{style:{minWidth:200},defaultValue:L.linkAttribute,value:L.linkAttribute,placeholder:f("import.select_link_attribute"),onChange:t=>c(e,t),children:L.attributes.filter(N).map((e=>l.jsx(s.Option,{value:e.id,children:y(e.label,j)||e.id},e.id)))})}),L.type===k.LINK&&(null==(h=L.linkAttributeProps)?void 0:h.type)===v.tree&&l.jsx(o.Item,{label:f("import.tree_link_library"),required:!0,children:l.jsx(s,{style:{minWidth:200},value:L.treeLinkLibrary,placeholder:f("import.select_library"),onChange:t=>p(e,t),options:C})})]})]})})}const P=b.div`
    width: 100%;
    display: flex;
    flex-direction: column;
`;function F({libraries:e,onGetAttributes:i}){const{lang:o}=a(),{t:m}=t(),{state:b,dispatch:h}=g(),{sheets:x}=b,j=(e,t)=>{x[e]={...x[e],...t},h({type:f.SET_SHEETS,sheets:[...x]})},I=async(e,t)=>{const l=await i(t);j(e,{library:t,attributes:l,mapping:[],linkAttribute:null,keyToAttributes:null})},L=(e,t)=>{j(e,{type:t,linkAttribute:null,keyToAttributes:null})},C=(e,t)=>{j(e,{mode:t})},T=async(e,t)=>{var l;const r=x[e],n=r.attributes.find((e=>e.id===t)),a=n.type===v.tree?r.treeLinkLibrary:null==(l=null==n?void 0:n.linked_library)?void 0:l.id;let o=[];a&&(o=await i(a));const s=r.mapping;j(e,{linkAttribute:t,linkAttributeProps:n,mapping:s,keyToAttributes:o,treeLinkLibrary:n.type===v.tree&&n.linked_tree.libraries.map((e=>e.library.id)).includes(r.treeLinkLibrary)?r.treeLinkLibrary:null})},w=(e,t,l)=>{const i=x[e];let r=[...i.mapping];r[t]=l,r=r.map(((e,r)=>r!==t&&e===l&&i.keyToColumnIndex!==r&&i.keyToColumnIndex!==t?null:e)),j(e,{mapping:r})},O=async(e,t)=>{const l=t?await i(t):null;j(e,{treeLinkLibrary:t,keyToAttributes:l})},N=x.map(((t,i)=>{const a=t.type===k.IGNORE,u=t.data.slice(0,3),h=(e,t)=>({style:{verticalAlign:"top",background:t===u.length?r.secondaryBg:r.defaultBg}}),x=[{value:"import_key",label:l.jsxs(l.Fragment,{children:[l.jsx(_,{})," ",m("import.import_key")]})}];t.type===k.LINK&&x.push({value:"link_key",label:l.jsxs(l.Fragment,{children:[l.jsx(A,{})," ",m("import.link_key")]})});const g=Object.keys(t.data[0]).map(((e,t)=>({title:e,dataIndex:e,onCell:h})));g.unshift({title:l.jsx(l.Fragment,{}),dataIndex:"__root",onCell:h,width:"250px"});const f=u.map(((e,t)=>({...e,key:t})));if(t.type&&t.library&&(t.type!==k.LINK||t.linkAttribute)){const e={key:f.length,__root:l.jsx(E,{sheet:t}),...Object.keys(t.data[0]).reduce(((e,r,a)=>{var d;const c=(t.keyToColumnIndex===a?(null==t?void 0:t.keyToAttributes)??[]:((null==t?void 0:t.attributes)??[]).filter((e=>(null==e?void 0:e.type)===v.simple||(null==e?void 0:e.type)===v.advanced))).map((e=>({value:e.id,key:e.id,label:y(e.label,o)||e.id})));var p;return e[r]=l.jsxs(n,{direction:"vertical",style:{width:"100%"},children:[l.jsx(s,{style:{width:"100%"},placeholder:m("import.do_not_import"),value:null==(d=t.mapping)?void 0:d[a],allowClear:!0,onClear:()=>w(i,a,null),onSelect:e=>w(i,a,e),options:c}),l.jsx(S,{sheet:t,columnIndex:a,onChange:(p=a,(e,l)=>{const r={},n=t.mapping[p],a="key"===e?"keyTo":"key",o="key"===e?"keyColumnIndex":"keyToColumnIndex",s="key"===e?"keyToColumnIndex":"keyColumnIndex";r[e]=l?n:null,r[o]=l?p:null,t[s]===p&&(r[a]=null,r[s]=null),"keyTo"===e&&(r.mapping=[...t.mapping],r.mapping[p]=null),j(i,r)})})]}),e}),{})};f.push(e)}return{label:l.jsxs(n,{children:[t.name,!!b.settingsError[t.name]&&l.jsx(d,{style:{color:r.errorColor}})]}),key:String(i),children:l.jsxs(P,{children:[l.jsx(K,{sheetIndex:i,libraries:e,onLibrarySelect:I,onImportTypeSelect:L,onImportModeSelect:C,onLinkAttributeSelect:T,onTreeLinkLibrarySelect:O}),!a&&l.jsx(c,{title:()=>l.jsx(p.Title,{level:5,children:m("import.data_overview")}),columns:g,dataSource:f,size:"small",tableLayout:"auto",pagination:{hideOnSinglePage:!0},style:{width:"100%",overflow:"auto"}})]})}}));return l.jsx(u,{type:"card",items:N})}export{F as default};
